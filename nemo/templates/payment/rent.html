{% extends "base.html" %}
{% block content %}
<div class="container small pb40">
    <div class="sideSlideWrap">
        <div id="view-initial" class="singleSlide active">
            <div class="viewListingTop">
                <div class="clearAfter">
                    <div class="pullLeft wow fadeIn" data-wow-delay=".5s">
                        <h3>{{ param.name }}</h3>
                        <address>
                            <i class="icon-location-1"></i>
                            {{ param.address }}
                        </address>
                    </div>
                    <div class="pullRight wow fadeIn" data-wow-delay=".5s">
                        <strong>${{ param.price }}</strong>
                        <span>Per day</span>
                    </div>
                </div>
            </div>
            <div class="clearAfter">
                <div class="listingViewL">
                    <figure class="wow fadeInDown listinhMainImg">
                        <img src="/media/images/items/{{ param.image_filename }}">
                    </figure>
                    <div class="listingRatingLine wow fadeInDown" data-wow-delay=".2s">
                        <div class="pullLeft">
                            <label class="block mb5">Item Rating</label>
                            <img src="/media/images/rating-badges.png">
                        </div>
                        <div class="pullRight">
                            <a href="/profile/conversation/{{ param.item_owner_id }}">Send Message</a>
                            <span>Contact<br>with owner</span>
                            <button class="btn btnPrime btnSquare">
                                <i class="icon-message"></i>
                            </button>
                        </div>
                    </div>
                    <div class="subSect wow fadeInDown" data-wow-delay=".4s">
                        <ul class="labelValueList evenOdd">
                            <li>
                                <label>Category:</label>
                                <span>{{ param.subcategory.name }}</span>
                            </li>
                            <li>
                                <label>Owner:</label>
                                <span class="success"><a href="#" class="txtBtn">{{ param.user_firstname }} {{ param.user_lastname }}</a></span>
                            </li>
                            <li>
                                <label>Rating Budges:</label>
                                <span><img src="/media/images/rating-badges.png" alt=""></span>
                            </li>
                            <li>
                                <label>Summary:</label>
                                <span class="days_amount">${{ param.price }} x 0 days</span>
                            </li>
                            <li>
                                <label>Todayâ€™s status:</label>
                                <span {% if param.rent_status == 'approved' and param.rent_start_date|date:"Y-m-d h:i:s" <= this_moment|date:"Y-m-d h:i:s" and param.rent_end_date|date:"Y-m-d h:i:s" >= this_moment|date:"Y-m-d h:i:s" %}class="danger">Not Available{% else %} class="success">Available{% endif %}</span>
                            </li>
                        </ul>
                    </div>
                    <div class="subSect wow fadeInDown" data-wow-delay=".6s">
                        <h4 class="subSectTitle">Description</h4>
                        <p>{{ param.description }}</p>
                    </div>
                </div>
                <div class="listingViewR wow fadeInDown" data-wow-delay="1s">
                    <div class="subSect wow fadeInDown" data-wow-delay=".8s">
                        <div class="gMap listingMap" id="gMap"></div>
                    </div>
                    <div class="datepicker mb5"></div>
                    <p class="additionalTxt">Reserve the dates when you need the item</p>
                    <div class="subSect wow fadeInDown" data-wow-delay=".4s">
                        <ul class="labelValueList evenOdd">
                            <li>
                                <label>Summary:</label>
                                <span class="days_amount">${{ param.price }} x 0 days</span>
                            </li>
                            <li>
                                <label>Total amount:</label>
                                <span id="total_amount">$0</span>
                            </li>
                        </ul>
                    </div>
                    <a href="#view-request" id='request_slide' class="rentSlideBtn btn btnBorder btnBlock disableBtn">Request</a>
                </div>
            </div>
        </div>

        <div id="view-request" class="singleSlide mt25">
            <form method="post" action="">
                {% csrf_token %}
                <div class="formRow">
                    {{ form.card_number.label_tag}}
                    {{ form.card_number }}
                    {{ form.card_number.errors }}
                </div>
                <div class="formRow">
                    {{ form.cvv.label_tag}}
                    {{ form.cvv }}
                    {{ form.cvv.errors }}
                </div>
                <div class="formRow">
                    {{ form.month.label_tag}}
                    {{ form.month }}
                    {{ form.month.errors }}
                </div>
                <div class="formRow">
                    {{ form.year.label_tag}}
                    {{ form.year }}
                    {{ form.year.errors }}
                </div>
                <div class="formRow">
                    {{ form.start_date }}
                </div>
                <div class="formRow">
                    {{ form.rent_date }}
                </div>
                <div class="colRow">
                    <div class="col6">
                        <a href="#view-initial" class="openSlideBtn btn btnBorder btnBlock">Back</a>
                    </div>
                    <div class="col6">
                        <input type="submit" value="Submit" class="btn btnBorder btnBlock">
                    </div>
                </div>
            </form>
        </div>
    </div>
</main>
<script>
$(document).ready(function() {

    var val_error = '{{val_error}}'
    if(val_error){
        $(".rentSlideBtn").trigger('click');
    }

    var price = '{{ param.price }}';
    var dates = new Object()

    {% for key,blockday in blockdays.items %}
        dates["{{key}}"] = "{{blockday}}"
    {% endfor %}

    dateRange = []
    for (var k in dates){
        var startDate = dates[k];
        var endDate  = k;
        for (var d = new Date(startDate); d <= new Date(endDate); d.setDate(d.getDate() + 1)) {
            dateRange.push($.datepicker.formatDate('yy-mm-dd', d));
        }
    }

    var dateToday = new Date();
    var lastDate = new Date(dateToday.getFullYear(), dateToday.getMonth()+6, 0);

    $.datepicker.setDefaults({
        dateFormat: 'yy-mm-dd'
    });
    $("#id_start_date,#id_rent_date").val('');
    $(".datepicker").datepicker({
		nextText: "",
		prevText: "",
		showOtherMonths: true,
        selectOtherMonths: true,
        minDate: dateToday,
        maxDate: lastDate,
        numberOfMonths: 1,
        beforeShowDay: function (date) {
            var date1 = $.datepicker.parseDate($.datepicker._defaults.dateFormat, $("#id_start_date").val());
            var date2 = $.datepicker.parseDate($.datepicker._defaults.dateFormat, $("#id_rent_date").val());
            var dateString = jQuery.datepicker.formatDate('yy-mm-dd', date);
            return [true, dateRange.indexOf(dateString) == -1 && date1 && ((date.getTime() == date1.getTime()) || (dateRange.indexOf(dateString) == -1 && date2 && date >= date1 && date <= date2)) ? "dp-highlight" : ""];
        },
        onSelect: function(dateText, inst) {
            var date1 = $.datepicker.parseDate($.datepicker._defaults.dateFormat, $("#id_start_date").val());
            var date2 = $.datepicker.parseDate($.datepicker._defaults.dateFormat, $("#id_rent_date").val());
            var selectedDate = $.datepicker.parseDate($.datepicker._defaults.dateFormat, dateText);
            if (!date1 || date2) {
                $("#id_start_date").val(dateText);
                $("#id_rent_date").val("");
                $(this).datepicker();
            } else if( selectedDate < date1 ) {
                $("#id_rent_date").val( $("#id_start_date").val() );
                $("#id_start_date").val( dateText );
                $(this).datepicker();
            } else {
                $("#id_rent_date").val(dateText);
                $(this).datepicker();
            }
            var result = validateDateRange();
            var start_date = new Date($("#id_start_date").val());
            var end_date = new Date($("#id_rent_date").val());
            var diff = Math.abs(end_date - start_date);
            var diffDays = Math.ceil(diff / (1000 * 3600 * 24));
            if(result && end_date != ''){
                if(diffDays == 0){
                    diffDays = 1;
                }else{
                    diffDays += 1;
                }
                var amount = price * diffDays ;
                $('.days_amount').text('$' + price + ' x ' + diffDays + ' day');
                $('#total_amount').text('$' + amount);
                $('#request_slide').removeClass('disableBtn');
                $(".datepicker").removeClass('not_valid');
            }else if(result && start_date != '' &&  start_date == ''){

            }else{
                $('#request_slide').addClass('disableBtn');
                $(".datepicker").addClass('not_valid');
                alert("Invalid Date Range");
            }
        },
	});
})

var myLatLng = {lat: parseFloat('{{param.latitude}}'), lng: parseFloat('{{param.longitude}}')};

var map = new google.maps.Map(document.getElementById('gMap'), {
    zoom: 10,
    center: myLatLng
});

var marker = new google.maps.Marker({
    position: myLatLng,
    map: map,
    title: '{{ param.name }}'
});

</script>
{% endblock %}
