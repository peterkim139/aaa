{% extends "base.html" %}
{% block content %}
{% load user_online %}
<div class="container pb80 pt40">
        <!--<div class="msgRelItem">-->
            <!--<div class="relItemImg">-->
                <!--<img src="media/images/thumbs/listing-img-1.jpg" alt="">-->
            <!--</div>-->
            <!--<h3 class="relItemTitle">Lorem ipsum item</h3>-->
            <!--<div class="relFromTo">-->
                <!--<button class="active">From</button>-->
                <!--<span>/</span>-->
                <!--<button>To</button>-->
            <!--</div>-->
            <!--<span class="relFromToName">Samuel L. Jackson</span>-->
        <!--</div>-->
        <div class="messagesWrap">
            <div class="messagesL tabsWrap">
                <ul class="tabs">
                    <!--<li><a href="#new-messages">New <br> Messages</a></li>-->
                    <li><a href="#recent-messages">Recent Messages</a></li>
                </ul>
                <div class="customScroll" style="height: 420px;">
                    <div id="new-messages">
                        <ul class="msgConvrsList">
                            {%if threads %}
                                {% for thread in threads %}
                                    <li id="user_{{thread.user_id}}">
                                        <a href="/profile/conversation/{{thread.user_id}}">
                                            <div>
                                                <div class="msgConvrsImg">
                                                    <img src="/media/{% if thread.user_photo %}{{ thread.user_photo }}{% else %}images/users/default_user_photo.jpg{% endif %}">
                                                    {% if  thread.message_count > 0 %}<span class="msgCount">{{thread.message_count}}</span>{% endif %}
                                                </div>
                                                <div class="msgConvrsR">
                                                    <strong class="msgConvrsName">{{ thread.user_first_name }} {{ thread.user_last_name }}</strong>
                                                    <span class="msgConvrsMsg" id="last_message_{{thread.id}}">{{thread.last_message}} - {% if thread|user_online %}Online{% else %}Offline{% endif %}</span>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                {% endfor %}
                            {% endif %}
                        </ul>
                    </div>
                    <!--<div id="recent-messages">-->
                        <!--<ul class="msgConvrsList">-->
                            <!--<li class="">-->
                                <!--<a href="#">-->
                                    <!--<div>-->
                                        <!--<div class="msgConvrsImg">-->
                                            <!--<img src="media/images/thumbs/user-img-2.jpg">-->
                                        <!--</div>-->
                                        <!--<div class="msgConvrsR">-->
                                            <!--<strong class="msgConvrsName">Samuel L. Jackson</strong>-->
                                            <!--<span class="msgConvrsMsg">Lorem ipsum dolor sit amet message here</span>-->
                                        <!--</div>-->
                                    <!--</div>-->
                                <!--</a>-->
                            <!--</li>-->
                        <!--</ul>-->
                    <!--</div>-->
                </div>
            </div>

            <div class="messagesR">
                <div class="customScroll wow fadeInDown" data-wow-delay=".2s" style="height: 420px;">
                    <ul class="msgThread">
                        {% if messages %}
                            {% for message in messages %}
                                <li {% if message.from_user_id.id = request.user.id %} class="msgSent" {% else %} class="msgReceived" {% endif %}>
                                    <div class="threadImg">
                                        <img src="/media/{% if message.from_user_id.photo %}{{ message.from_user_id.photo }}{% else %}images/users/default_user_photo.jpg{% endif %}">
                                    </div>
                                    <div class="threadCont">
                                        <div class="clearAfter">
                                            <div class="threadTxt">
                                                <p>{{ message.message }}</p>
                                            </div>
                                        </div>
                                        <time>{{message.modified|date:"F d, H:i"}}</time>
                                    </div>
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </div>

                <div class="msgReplyArea wow fadeInDown" data-wow-delay=".4s">
                    <div class="formRow">
                        <textarea class="formControl" id="id_message" placeholder="Reply..."></textarea>
                    </div>
                    <div class="alignC">
                        <button type="button" id="send_message" class="btn btnBorder">Send</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div id="sound"></div>
</main>

<script>
$(document).ready(function(){
    /////////////// get partner_id from url /////////////////

    var url = document.URL;
    var stuff = url.split('/');
    var partner_id = stuff[stuff.length-1];
    $('#user_'+partner_id).addClass('newMsg')

    ////////////// get unread_messages ///////////////////////

    setInterval(function(){checkData()}, 10000);
    function checkData(){
        $.ajax({
            url: '/profile/unread_messages/',
            type:'post',
            data:{
                partner_id:partner_id
            },
            success:function(response) {
                if(response != ''){
                    message_div = '';

                    jQuery.each(response, function(index, element) {

                        if (element.from_user_id__photo)
                            { var photo = element.from_user_id__photo;
                             }
                        else {
                            var photo = 'images/users/default_user_photo.jpg'
                            }

                        message_div += '<li class="msgReceived">'
                                        +'<div class="threadImg">'
                                            +'<img src="/media/'+ photo +'">'

                                        +'</div>'
                                        +'<div class="threadCont">'
                                            +'<div class="clearAfter">'
                                                +'<div class="threadTxt">'
                                                    +'<p>'+element.message+'</p>'
                                                +'</div>'
                                            +'</div>'
                                            +'<time>'+element.modified+'</time>'
                                        +'</div>'
                                    +'</li>'
                        $('#last_message_'+element.thread_id).text(element.message);
                    });
                    playSound();
                    $(".msgThread").append(message_div);
                }
            },
            error:function(){
            }
        });
    }

    ////////////////////// post message  ////////////////////////////

    $("#send_message").on('click',function(){
        var message = $('#id_message').val();
        if (message.trim()) {
            $.ajax({
                    url: '/profile/conversation/'+partner_id,
                    type:'post',
                    data:{
                        message: message
                    },
                    success:function(responseJSON) {
                        if(responseJSON.response){
                            var thread_id = responseJSON.thread_id

                            var user_photo = '{{ request.user.photo }}';

                            if (user_photo){
                                var photo = user_photo
                            }else {
                                var photo = 'images/users/default_user_photo.jpg'
                            }

                            var next_li = '<li class="msgSent">'
                                                +'<div class="threadImg">'
                                                    +'<img src="/media/'+photo+'">'
                                                +'</div>'
                                                +'<div class="threadCont">'
                                                    +'<div class="clearAfter">'
                                                        +'<div class="threadTxt">'
                                                            +'<p>'+message+'</p>'
                                                        +'</div>'
                                                    +'</div>'
                                                    +'<time>'+responseJSON.modified+'</time>'
                                                +'</div>'
                                            +'</li>'
                            $('.msgThread').append(next_li);
                            $('#id_message').val('');
                            $('#last_message_'+thread_id).text(message);
                        }
                    },
                    error:function(){
                    }
            });
        }
    });
});
</script>

{% endblock %}