{% extends "base.html" %}
{% block content %}
{% load user_online %}
<div class="container pb80 pt40">
    <!--<div class="msgRelItem">-->
        <!--<div class="relItemImg">-->
            <!--<img src="media/images/thumbs/listing-img-1.jpg" alt="">-->
        <!--</div>-->
        <!--<h3 class="relItemTitle">Lorem ipsum item</h3>-->
        <!--<div class="relFromTo">-->
            <!--<button class="active">From</button>-->
            <!--<span>/</span>-->
            <!--<button>To</button>-->
        <!--</div>-->
        <!--<span class="relFromToName">Samuel L. Jackson</span>-->
    <!--</div>-->
    <div class="messagesWrap">
        <div class="messagesL tabsWrap">
            <ul class="tabs">
                <!--<li><a href="#new-messages">New <br> Messages</a></li>-->
                <li><a href="#recent-messages">Recent Messages</a></li>
            </ul>
            <div class="customScroll" style="height: 620px;">
                <div id="new-messages">
                    <ul class="msgConvrsList">
                        {%if threads %}
                            {% for thread in threads %}
                                <li id="user_{{thread.user_id}}">
                                    <a href="{% url 'profile:conversation' thread.user_id %}">
                                        <div>
                                            <div class="msgConvrsImg fluidImage" style="background-image: url(/media/{% if thread.user_photo %}{{ thread.user_photo }}{% else %}images/users/default_user_photo.jpg{% endif %})">
                                                <img class="imgBlock" src="/media/images/sizers/square-sizer.png">
                                                <span id="count_{{thread.user_id}}" {% if  thread.message_count > 0 %}class="msgCount">{{thread.message_count}}{% else %}>{% endif %}</span>
                                            </div>
                                            <div class="msgConvrsR">
                                                <strong class="msgConvrsName">{{ thread.user_first_name }} {{ thread.user_last_name|striptags }}
                                                    <!--<span id="status_{{thread.user_id}}"{% if thread|user_online %}class="userStatus online">Online{% else %}class="userStatus offline">Offline{% endif %}</span>-->
                                                </strong>
                                                <span class="msgConvrsMsg" id="last_message_{{thread.user_id}}">{{thread.last_message|striptags}}</span>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </div>
                <!--<div id="recent-messages">-->
                    <!--<ul class="msgConvrsList">-->
                        <!--<li class="">-->
                            <!--<a href="#">-->
                                <!--<div>-->
                                    <!--<div class="msgConvrsImg">-->
                                        <!--<img src="media/images/thumbs/user-img-2.jpg">-->
                                    <!--</div>-->
                                    <!--<div class="msgConvrsR">-->
                                        <!--<strong class="msgConvrsName">Samuel L. Jackson</strong>-->
                                        <!--<span class="msgConvrsMsg">Lorem ipsum dolor sit amet message here</span>-->
                                    <!--</div>-->
                                <!--</div>-->
                            <!--</a>-->
                        <!--</li>-->
                    <!--</ul>-->
                <!--</div>-->
            </div>
        </div>
        <div class="messagesR">
            <div class="customScroll scrollBottom wow fadeInDown" data-wow-delay=".2s" style="max-height: 420px;">
                <ul class="msgThread">
                    {% if messages %}
                        {% for message in messages %}
                            <li {% if message.from_user_id.id = request.user.id %} class="msgSent" {% else %} class="msgReceived" {% endif %}>
                                <div class="threadImg">
                                    <img src="/media/{% if message.from_user_id.photo %}{{ message.from_user_id.photo }}{% else %}images/users/default_user_photo.jpg{% endif %}">
                                </div>
                                <div class="threadCont">
                                    <div class="clearAfter">
                                        <div class="threadTxt">
                                            <p>{{ message.message|striptags }}</p>
                                        </div>
                                    </div>
                                    <time>{{message.modified|date:"F d, Y h:i A"}}</time>
                                </div>
                            </li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </div>
            <div class="msgReplyArea wow fadeInDown" data-wow-delay=".4s">
                <div class="formRow">
                    <textarea class="formControl" id="id_message" placeholder="Reply..."></textarea>
                </div>
                <div class="alignC">
                    <button type="button" id="send_message" class="btn btnBorder">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="sound"></div>
</div>

<script>

$(document).ready(function(){

    /////////////// get partner_id from url /////////////////

    var url = document.URL;
    var stuff = url.split('/');
    var partner_id = stuff[stuff.length-1];
    $('#user_'+partner_id).addClass('newMsg')

    ////////////// get unread_messages ///////////////////////

    setInterval(function(){checkData()}, 5000);
    function checkData(){
        $.ajax({
            url: '/profile/unread_messages/',
            type:'post',
            data:{
                partner_id:partner_id
            },
            success:function(response) {
                if(response != ''){
                    message_div = '';

                    jQuery.each(response, function(index, element) {

                        if (element.from_user_id__photo)
                            { var photo = element.from_user_id__photo;
                             }
                        else {
                            var photo = 'images/users/default_user_photo.jpg'
                            }

                        message_div += '<li class="msgReceived">'
                                        +'<div class="threadImg">'
                                            +'<img src="/media/'+ photo +'">'

                                        +'</div>'
                                        +'<div class="threadCont">'
                                            +'<div class="clearAfter">'
                                                +'<div class="threadTxt">'
                                                    +'<p>'+element.message+'</p>'
                                                +'</div>'
                                            +'</div>'
                                            +'<time>'+element.modified+'</time>'
                                        +'</div>'
                                    +'</li>'
                        $('#last_message_'+partner_id).text(element.message);
                    });
                    playSound();
                    $(".msgThread").append(message_div);
                    $('.messagesR .customScroll').mCustomScrollbar("scrollTo","bottom")
                }
            },
            error:function(){
            }
        });
    }

    ////////////// get users' statuses ///////////////////////

    // setInterval(function(){checkStatusData()}, 60000);
    function checkStatusData(){
        $.ajax({
            url: '/profile/user_status/',
            type:'post',
            data:{
            },
            success:function(response) {
                if(response){
                    jQuery.each(response, function(index, element) {

                        var status_class = $('#status_'+element.id).attr('class');

                        if (element.online == true) {
                            if (status_class == "Offline") {
                                $('#status_'+element.id).toggleClass('userStatus online');
                                $('#status_'+element.id).text("Online");
                                }
                            }
                        else {
                            if (status_class == "Online") {
                                $('#status_'+element.id).toggleClass('userStatus offline');
                                $('#status_'+element.id).text("Offline");
                                }
                        }

                        if (partner_id !== element.id) {
                            if (element.message_count > 0) {
                                if ($('#count_'+element.id).attr('class') !== 'msgCount'){
                                    $('#count_'+element.id).addClass('msgCount');
                                }
                                $('#count_'+element.id).text(element.message_count);
                                }
                            else {
                                $('#count_'+element.id).removeClass('msgCount');
                            }
                            if (element.message_text !== null) {
                                $('#last_message_'+element.id).text(element.message_text);
                            }
                        }
                    });
                }
            },
            error:function(){
            }
        });
    }

    ////////////////////// post message  ////////////////////////////

    $("#send_message").on('click',function(){
        var message = $('#id_message').val();
        if (message.trim()) {
            $.ajax({
                    url: '/profile/conversation/'+partner_id,
                    type:'post',
                    data:{
                        message: message
                    },
                    success:function(responseJSON) {
                        if(responseJSON.response){
                            var user_photo = '{{ request.user.photo }}';

                            if (user_photo){
                                var photo = user_photo
                            }else {
                                var photo = 'images/users/default_user_photo.jpg'
                            }

                            var next_li = '<li class="msgSent">'
                                                +'<div class="threadImg">'
                                                    +'<img src="/media/'+photo+'">'
                                                +'</div>'
                                                +'<div class="threadCont">'
                                                    +'<div class="clearAfter">'
                                                        +'<div class="threadTxt">'
                                                            +'<p>'+responseJSON.last_message+'</p>'
                                                        +'</div>'
                                                    +'</div>'
                                                    +'<time>'+responseJSON.modified+'</time>'
                                                +'</div>'
                                            +'</li>'
                            $('.msgThread').append(next_li);
                            $('#id_message').val('');
                            $('#last_message_'+partner_id).text(message);
                            $('.messagesR .customScroll').mCustomScrollbar("scrollTo","bottom")
                        }else{
                            alert('error');
                        }
                    },
                    error:function(){
                    }
            });
        }
    });

    $(".scrollBottom").mCustomScrollbar("scrollTo","bottom");
});
</script>

{% endblock %}